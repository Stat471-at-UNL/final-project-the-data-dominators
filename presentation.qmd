---
title: 'BRFSS R Package'
engine: knitr
type: slides
format:
  revealjs:
    transition: slide
    background-transition: fade
    navigation-mode: vertical
    logo: ../../N.svg
    includes:
      in_header: ../../header.html
---

```{r, include=FALSE}

## *All code taken from data-cleaning.R* ##

library(haven)
library(tidyverse)
library(mice)
library(patchwork)

###################################
##### EDA / Preparation ###########
###################################

# Load the data
brfss_2024 <- read_xpt(unz("data/LLCP2024XPT.zip", "LLCP2024.XPT ")) # 457,670 records
brfss_2023 <- read_xpt(unz("data/LLCP2023XPT.zip", "LLCP2023.XPT ")) # 433,323 records

# Get just Missouri's data
brfss_2024 <- brfss_2024 %>% filter(`_STATE` == 29.00)
brfss_2023 <-brfss_2023 %>% filter(`_STATE` == 29)

# Locating columns that weren't included in Missouri's modules
brfss_2024 %>%
  summarise(
    across(everything(), ~ sum(!is.na(.)))
  ) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "n_na") %>%
  filter(n_na != 0)

# Selecting only the columns that we are going to focus on (this is just a start, might add/drop)
brfss_2024_tob_cog <- brfss_2024 %>%
  select(`SEQNO`, # Key
         `IDAY`, `IMONTH`, `IYEAR`, # Survey Date
         `SMOKE100`, `ECIGNOW3`, # Tobacco Use
         `CIMEMLO1`, # Cognitive Decline
         `MARITAL`, `EDUCA`, `VETERAN3`, `EMPLOY1`, `CHILDREN`, `INCOME3`, `PREGNANT`, `WEIGHT2`, `_CRACE1`, # Demographics
         `_ASTHMS1`, `_SMOKER3`, `CAGEG`, `_AGE80`, `CHCOCNC1`, `ALCDAY4`, `MARJSMOK`, `GENHLTH`, `MENTHLTH` # Extras
         ) %>%
  rename(ECIGNOW = ECIGNOW3, # for uniform names
         CRACE1 = `_CRACE1`, # the rest are changed to not cause problems in mice
         ASTHMS1 = `_ASTHMS1`,
         SMOKER3 = `_SMOKER3`,
         AGE80 = `_AGE80`
         )

brfss_2023_tob_cog <- brfss_2023 %>%
  select(`SEQNO`, # Key
         `IDAY`, `IMONTH`, `IYEAR`, # Survey Date
         `SMOKE100`, `ECIGNOW2`, # Tobacco Use
         `CIMEMLO1`, # Cognitive Decline
         `MARITAL`, `EDUCA`, `VETERAN3`, `EMPLOY1`, `CHILDREN`, `INCOME3`, `PREGNANT`, `WEIGHT2`, `_CRACE1`, # Demographics
         `_ASTHMS1`, `_SMOKER3`, `CAGEG`, `_AGE80`, `CHCOCNC1`, `ALCDAY4`, `MARJSMOK`, `GENHLTH`, `MENTHLTH` # Extras
         ) %>%
  rename(ECIGNOW = ECIGNOW2, # for uniform names
         CRACE1 = `_CRACE1`, # the rest are changed to not cause problems in mice
         ASTHMS1 = `_ASTHMS1`,
         SMOKER3 = `_SMOKER3`,
         AGE80 = `_AGE80`
         )


###################################
##### IMPUTING MISSING VALUES #####
###################################

# Joining the two datasets for imputation / tidying
brfss_tob_cog <- bind_rows(brfss_2023_tob_cog, brfss_2024_tob_cog)

# Turning the values of 7 (Don't know) and 9 (Refused) to NAs so that they are imputed too
brfss_for_imp <- brfss_tob_cog %>%
  mutate(
    SMOKE100 = ifelse(SMOKE100 %in% c(7, 9), NA, SMOKE100),
    ECIGNOW = ifelse(ECIGNOW %in% c(7, 9), NA, ECIGNOW),
    CIMEMLO1 = ifelse(CIMEMLO1 %in% c(7, 9), NA, CIMEMLO1)
  )

#
# Imputing
#

# Dry run to get the matrix skeleton, so that we can alter it for each column
ini <- mice(brfss_for_imp, maxit = 0)
pred <- ini$predictorMatrix
# Reset the entire matrix to 0
pred[,] <- 0

# Predictors (everything except the targets)
predictors <- c("MARITAL", "EDUCA", "VETERAN3", "EMPLOY1", "CHILDREN", "INCOME3", "PREGNANT", "WEIGHT2", "CRACE1",
                "ASTHMS1", "CAGEG", "AGE80", "CHCOCNC1", "ALCDAY4", "MARJSMOK", "GENHLTH", "MENTHLTH")

# Set Predictors for each target column
pred["SMOKE100", predictors] <- 1
pred["ECIGNOW", predictors] <- 1
pred["CIMEMLO1", predictors] <- 1

# Actual imputation
brfss_imputed <- mice(
  brfss_for_imp,
  m = 3,
  predictorMatrix = pred,
  method = "pmm",
  seed = 20251124,
  print = FALSE
)

#
# Loop to add imputed values
#
brfss_complete <- brfss_tob_cog
for(i in 1:3) {
  # Imputed data for the i-th imputation
  completed <- complete(brfss_imputed, action = i)

  # Select only the target columns
  imp_cols <- completed %>%
    select(all_of(c("SMOKE100", "ECIGNOW", "CIMEMLO1"))) %>%
    rename_with(~ paste0(., "_IMP", i))  # renaming them for clarity

  # Append to complete dataset
  brfss_complete <- bind_cols(brfss_complete, imp_cols)
}

```


```{r, include=FALSE}
# code from missing-values.R
library(haven)

brfss_2024 <- read_xpt(unz("data/LLCP2024XPT.zip", "LLCP2024.XPT ")) # 457,670 records
brfss_2023 <- read_xpt(unz("data/LLCP2023XPT.zip", "LLCP2023.XPT ")) # 433,323 records

##code taken from missing-values.R* ##

library(dplyr)
library(naniar)
library(haven)
library(tidyverse)
library(ggplot2)
library(visdat)

# recode 'dont know' and 'refused' to NA
recode_brfs_missing <- function(x) {
  miss_codes <- c(7, 9, 77, 99)
  replace(x, x %in% miss_codes, NA)
}

# define variable name
tobacco_vars  <- c("SMOKE100", "SMOKDAY2", "USENOW3", "ECIGNOW2", "ECIGNOW3")

cognitive_vars <- c("CIMEMLO1", "CDHOUS1", "CDSOCIA1")

demo_vars <- c(
  "MARITAL", "EDUCA", "VETERAN3", "EMPLOY1", "CHILDREN",
  "INCOME3", "PREGNANT", "WEIGHT2", "_CRACE1", "_ASTHMS1",
  "CAGEG", "_AGE80", "CHCOCNC1", "ALCDAY4", "MARJSMOK",
  "GENHLTH", "MENTHLTH"
)

# figure out which of these exist in each year
tobacco_vars_2023   <- intersect(tobacco_vars,   names(brfss_2023))
tobacco_vars_2024   <- intersect(tobacco_vars,   names(brfss_2024))
cognitive_vars_2023 <- intersect(cognitive_vars, names(brfss_2023))
cognitive_vars_2024 <- intersect(cognitive_vars, names(brfss_2024))

# recode missing for selected vars
brfss_2023_missing <- brfss_2023 |>
  mutate(
    across(all_of(tobacco_vars_2023),   recode_brfs_missing),
    across(all_of(cognitive_vars_2023), recode_brfs_missing),
    `_SMOKER3` = replace(`_SMOKER3`, `_SMOKER3` == 9, NA)
  )

brfss_2024_missing <- brfss_2024 |>
  mutate(
    across(all_of(tobacco_vars_2024),   recode_brfs_missing),
    across(all_of(cognitive_vars_2024), recode_brfs_missing),
    `_SMOKER3` = replace(`_SMOKER3`, `_SMOKER3` == 9, NA)
  )

# only keep vars present in both years
vars_all <- c(demo_vars, cognitive_vars, tobacco_vars)

vars_2023 <- intersect(vars_all, names(brfss_2023_missing))
vars_2024 <- intersect(vars_all, names(brfss_2024_missing))

vars_both <- intersect(vars_2023, vars_2024)

# combined 2023 and 2024
combined_brfss <- bind_rows(
  brfss_2023_missing|>
    mutate(year = "2023") |>
    select(year, all_of(vars_both)),
  brfss_2024_missing|>
    mutate(year = "2024") |>
    select(year, all_of(vars_both))
)
# summary of missingness
miss_summary <- combined_brfss |>
  group_by(year) |>
  miss_var_summary() |>
  ungroup()


# map variable to group
var_domains <- tibble(
  variable = vars_both,
  domain   = case_when(
    variable %in% demo_vars      ~ "Demographic",
    variable %in% cognitive_vars ~ "Cognitive",
    variable %in% tobacco_vars   ~ "Tobacco",
    TRUE ~ "Other"
  )
)

miss_summary <- miss_summary |>
  left_join(var_domains, by = "variable") |>
  mutate(
    domain   = if_else(is.na(domain), "Other", domain),
    pct_miss = as.numeric(pct_miss)
  )
```

# Outline

- Introduction
- Dataset
- Cleaning the Data
  - Investigating Missing Values
  - Imputing Missing Values
  - Tidying the Dataset
- R Package
- Conclusion
- Questions

# Dataset

- BRFSS Data
  - The CDC regularly conduct telephone surveys to collect this health-related data about U.S. residents
  - Time period: 2023 and 2024
- We filtered the dataset to only use records from the state of Missouri.
- Focused on the **Cognitive Decline** and **Tobacco Use** modules for analyzing and data-cleaning
- Kept important **Demographics** to provide basic info, as well as for imputation

## Demographics

## Cognitive Decline

## Tobacco Use

# Cleaning the Data

## Investigating Missing Values
#### Goals:

-   Quantify how much data are missing

-   Explore missingness (MCAR / MAR / MNAR)

-   Decide which variables to impute

#### **Variables:**

-   Cognitive decline module

-   Tobacco use module

-   Key demographics

## How much is Missing?
```{r, echo=FALSE, warning=FALSE}
# missing variables visualization
p_miss_bar <- ggplot(
  miss_summary |> filter(domain != "Other"),
  aes(
    x   = as.numeric(pct_miss),
    y   = fct_reorder(variable, as.numeric(pct_miss)),
    fill = year
  )
) +
  geom_col(
    aes(x = 50),            
    fill  = "grey80",        
    colour = NA,
    alpha = 0.3          
  ) +
  geom_col(position = "dodge", alpha = 1) +
  facet_grid(domain ~ ., scales = "free_y", space = "free") +
  labs(
    title = "Percent missing by variable and year (2023 vs 2024)",
    x     = "% missing",
    y     = "Variable",
    fill  = "Year"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8)
  )

p_miss_bar

```

## Missingness in Cognitive Module
```{r echo=FALSE}
library(dplyr)
miss_summary |>
  filter(variable %in% c("CIMEMLO1", "CDHOUS1", "CDSOCIA1")) |>
  arrange(variable, year) |>
  select(year, variable, pct_miss)
```

## Testing MCAR
```{r, echo=TRUE}
library(naniar)
# tobacco variables
tobacco_vars <- c("SMOKE100", "SMOKDAY2", "USENOW3", "ECIGNOW2", "ECIGNOW3")

# keep variables that exist in 2023
tobacco_vars_2023 <- intersect(tobacco_vars, names(brfss_2023_missing))

# MCAR test
tobacco_2023 <- brfss_2023_missing |>
  select(all_of(tobacco_vars_2023))

mcar_tobacco_2023 <-mcar_test(tobacco_2023)
mcar_tobacco_2023
```


## Imputing Missing Values

## Tidying the Dataset

# R Package

To install and load the package:

```{r, results='hide', message=FALSE, warning=FALSE}
remotes::install_github("mfehr7/BRFSSMissouri")
library(BRFSSMissouri)
```

The datasets are automatically loaded in as global variables:

```{r, eval=FALSE}
# Complete dataset
missouri_brfss

# Sub-datasets
demographics
tobacco_use
cognitive_decline
```

## Example Usage

As an example analysis, this code looks at the average `SMOKE100` value
(using `SMOKE100_IMP1`) among different ages.

```{r}
# Summary table
smoke_by_age <- missouri_brfss %>%
  group_by(AGE80) %>%
  summarise(`AVG_SMOKE100` = mean(SMOKE100_IMP1))

# Summary plot
smoke_by_age %>%
  ggplot(aes(x = AGE80, y = AVG_SMOKE100)) + geom_bar(stat = "identity")
```

## Example Usage

- A value of 1 indicates that a person *has* smoked 100 cigarettes
- a value of 2 indicates that a person *has not*
- The trend seen in the plot is what you would expect, as cigarettes were more common for older
generations growing up than they are now
- Younger ages have an average
closer to 2, due to alternate, popular nicotine devices

# Conclusion
- In this project, we transformed raw BRFSS Missouri data into a clean,
well-structured, and user-friendly R package that makes access easier to
two important public health modules: Cognitive Decline and Tobacco Use.

- By downloading and cleaning the 2023 and 2024 datasets, we created a
reproducible workflow that makes these large and complex data files
available with a single function call. 

- Our work addressed challenges
such as inconsistent variable naming across years, missing values, and
imputating missing values, while still allowing the usability of the
original survey responses.

## Conclusion
- Through MCAR testing, we confirmed that missingness patterns were not
completely at random, and we used Predictive Mean Matching (PMM) to
impute three fields.

- Plots showed that the PMM imputations closely
reflected the original data distributions, showing that PMM worked well.

- After imputation, we reorganized the cleaned data into tidy seperate
datasets (Demographics, CognitiveDecline, and TobaccoUse) built using
SEQNO as a key. This structure makes the dataset easier to explore and
analyze in future projects.

# Questions
