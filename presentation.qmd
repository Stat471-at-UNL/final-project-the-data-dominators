---
title: 'BRFSS R Package'
engine: knitr
type: slides
format:
  revealjs:
    transition: slide
    background-transition: fade
    navigation-mode: vertical
    logo: ../../N.svg
    includes:
      in_header: ../../header.html
---

```{r, include=FALSE}
library(tidyverse)
```

```{r, include=FALSE}
# code from missing-values.R
library(haven)

brfss_2024 <- read_xpt(unz("data/LLCP2024XPT.zip", "LLCP2024.XPT ")) # 457,670 records
brfss_2023 <- read_xpt(unz("data/LLCP2023XPT.zip", "LLCP2023.XPT ")) # 433,323 records

##code taken from missing-values.R* ##

library(dplyr)
library(naniar)
library(haven)
library(tidyverse)
library(ggplot2)
library(visdat)

# recode 'dont know' and 'refused' to NA
recode_brfs_missing <- function(x) {
  miss_codes <- c(7, 9, 77, 99)
  replace(x, x %in% miss_codes, NA)
}

# define variable name
tobacco_vars  <- c("SMOKE100", "SMOKDAY2", "USENOW3", "ECIGNOW2", "ECIGNOW3")

cognitive_vars <- c("CIMEMLO1", "CDHOUS1", "CDSOCIA1")

demo_vars <- c(
  "MARITAL", "EDUCA", "VETERAN3", "EMPLOY1", "CHILDREN",
  "INCOME3", "PREGNANT", "WEIGHT2", "_CRACE1", "_ASTHMS1",
  "CAGEG", "_AGE80", "CHCOCNC1", "ALCDAY4", "MARJSMOK",
  "GENHLTH", "MENTHLTH"
)

# figure out which of these exist in each year
tobacco_vars_2023   <- intersect(tobacco_vars,   names(brfss_2023))
tobacco_vars_2024   <- intersect(tobacco_vars,   names(brfss_2024))
cognitive_vars_2023 <- intersect(cognitive_vars, names(brfss_2023))
cognitive_vars_2024 <- intersect(cognitive_vars, names(brfss_2024))

# recode missing for selected vars
brfss_2023_missing <- brfss_2023 |>
  mutate(
    across(all_of(tobacco_vars_2023),   recode_brfs_missing),
    across(all_of(cognitive_vars_2023), recode_brfs_missing),
    `_SMOKER3` = replace(`_SMOKER3`, `_SMOKER3` == 9, NA)
  )

brfss_2024_missing <- brfss_2024 |>
  mutate(
    across(all_of(tobacco_vars_2024),   recode_brfs_missing),
    across(all_of(cognitive_vars_2024), recode_brfs_missing),
    `_SMOKER3` = replace(`_SMOKER3`, `_SMOKER3` == 9, NA)
  )

# only keep vars present in both years
vars_all <- c(demo_vars, cognitive_vars, tobacco_vars)

vars_2023 <- intersect(vars_all, names(brfss_2023_missing))
vars_2024 <- intersect(vars_all, names(brfss_2024_missing))

vars_both <- intersect(vars_2023, vars_2024)

# combined 2023 and 2024
combined_brfss <- bind_rows(
  brfss_2023_missing|>
    mutate(year = "2023") |>
    select(year, all_of(vars_both)),
  brfss_2024_missing|>
    mutate(year = "2024") |>
    select(year, all_of(vars_both))
)
# summary of missingness
miss_summary <- combined_brfss |>
  group_by(year) |>
  miss_var_summary() |>
  ungroup()


# map variable to group
var_domains <- tibble(
  variable = vars_both,
  domain   = case_when(
    variable %in% demo_vars      ~ "Demographic",
    variable %in% cognitive_vars ~ "Cognitive",
    variable %in% tobacco_vars   ~ "Tobacco",
    TRUE ~ "Other"
  )
)

miss_summary <- miss_summary |>
  left_join(var_domains, by = "variable") |>
  mutate(
    domain   = if_else(is.na(domain), "Other", domain),
    pct_miss = as.numeric(pct_miss)
  )
```

# Outline

- Dataset
  - Demographics
  - Cognitive Decline
  - Tobacco Use
- Cleaning the Data
  - Investigating Missing Values
  - Imputing Missing Values
  - Tidying the Dataset
- R Package
  - Example Usage
- Questions

# Dataset

## Demographics

## Cognitive Decline

## Tobacco Use

# Cleaning the Data

## Investigating Missing Values
#### Goals:

-   Quantify how much data are missing

-   Explore missingness (MCAR / MAR / MNAR)

-   Decide which variables to impute

#### **Variables:**

-   Cognitive decline module

-   Tobacco use module

-   Key demographics

## How much is Missing?
```{r, echo=FALSE, warning=FALSE}
# missing variables visualization
p_miss_bar <- ggplot(
  miss_summary |> filter(domain != "Other"),
  aes(
    x   = as.numeric(pct_miss),
    y   = fct_reorder(variable, as.numeric(pct_miss)),
    fill = year
  )
) +
  geom_col(
    aes(x = 50),            
    fill  = "grey80",        
    colour = NA,
    alpha = 0.3          
  ) +
  geom_col(position = "dodge", alpha = 1) +
  facet_grid(domain ~ ., scales = "free_y", space = "free") +
  labs(
    title = "Percent missing by variable and year (2023 vs 2024)",
    x     = "% missing",
    y     = "Variable",
    fill  = "Year"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8)
  )

p_miss_bar

```

## Missingness in Cognitive Module
```{r echo=FALSE}
library(dplyr)
miss_summary |>
  filter(variable %in% c("CIMEMLO1", "CDHOUS1", "CDSOCIA1")) |>
  arrange(variable, year) |>
  select(year, variable, pct_miss)
```

## Testing MCAR
```{r, echo=TRUE}
library(naniar)
# tobacco variables
tobacco_vars <- c("SMOKE100", "SMOKDAY2", "USENOW3", "ECIGNOW2", "ECIGNOW3")

# keep variables that exist in 2023
tobacco_vars_2023 <- intersect(tobacco_vars, names(brfss_2023_missing))

# MCAR test
tobacco_2023 <- brfss_2023_missing |>
  select(all_of(tobacco_vars_2023))

mcar_tobacco_2023 <-mcar_test(tobacco_2023)
mcar_tobacco_2023
```


## Imputing Missing Values

## Tidying the Dataset

# R Package

## Example Usage

To install and load the package:

```{r, results='hide', message=FALSE, warning=FALSE}
remotes::install_github("mfehr7/BRFSSMissouri")
library(BRFSSMissouri)
```

The datasets are automatically loaded in as global variables:

```{r, eval=FALSE}
# Complete dataset
missouri_brfss

# Sub-datasets
demographics
tobacco_use
cognitive_decline
```

As an example analysis, this code looks at the average `SMOKE100` value
(using `SMOKE100_IMP1`) among different ages.

```{r}
# Summary table
smoke_by_age <- missouri_brfss %>%
  group_by(AGE80) %>%
  summarise(`AVG_SMOKE100` = mean(SMOKE100_IMP1))

# Summary plot
smoke_by_age %>%
  ggplot(aes(x = AGE80, y = AVG_SMOKE100)) + geom_bar(stat = "identity")
```

A value of 1 indicates that a person *has* smoked 100 cigarettes, while
a value of 2 indicates that a person *has not*. The trend seen in the
plot is what you would expect, as cigarettes were more common for older
generations growing up than they are now. Younger ages have an average
closer to 2, since their generations have alternate, popular nicotine
devices.

# Questions
